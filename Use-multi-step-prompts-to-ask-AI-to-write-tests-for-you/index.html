<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>13 使用多步提示语让AI帮你写测试 - 茶桁.MAMT</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="茶桁.MAMT"><meta name="msapplication-TileImage" content="https://qiniu.hivan.me/picGo/20230601174411.png?imgNote"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="茶桁.MAMT"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Hi，大家好，我是茶桁。 很遗憾在上一讲，也就是第12讲的时候，咱们对于利用AI写一个VBA宏来执行Excel任务的过程并不顺利，仔细想来既然大家都在这里看这个系列文章了，应该也基本都会Python的，所以一个Excel自动化也并无太大影响，毕竟，这种商业软件的集成一定是早晚的事情，咱们也不必在这里死磕这一个问题。"><meta property="og:type" content="blog"><meta property="og:title" content="13 使用多步提示语让AI帮你写测试"><meta property="og:url" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/"><meta property="og:site_name" content="茶桁.MAMT"><meta property="og:description" content="Hi，大家好，我是茶桁。 很遗憾在上一讲，也就是第12讲的时候，咱们对于利用AI写一个VBA宏来执行Excel任务的过程并不顺利，仔细想来既然大家都在这里看这个系列文章了，应该也基本都会Python的，所以一个Excel自动化也并无太大影响，毕竟，这种商业软件的集成一定是早晚的事情，咱们也不必在这里死磕这一个问题。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171814.png"><meta property="og:image" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171823.png"><meta property="og:image" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171829.png"><meta property="og:image" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171833.png"><meta property="og:image" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171841.png"><meta property="og:image" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171855.png"><meta property="article:published_time" content="2023-05-28T09:17:32.000Z"><meta property="article:modified_time" content="2023-06-01T12:56:08.576Z"><meta property="article:author" content="Hivan Du"><meta property="article:tag" content="AI"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171814.png"><meta property="twitter:creator" content="@hivan"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/"},"headline":"13 使用多步提示语让AI帮你写测试","image":["https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171814.png","https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171823.png","https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171829.png","https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171833.png","https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171841.png","https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171855.png"],"datePublished":"2023-05-28T09:17:32.000Z","dateModified":"2023-06-01T12:56:08.576Z","author":{"@type":"Person","name":"Hivan Du"},"publisher":{"@type":"Organization","name":"茶桁.MAMT","logo":{"@type":"ImageObject","url":"https://hivan.me/img/logo.svg"}},"description":"Hi，大家好，我是茶桁。 很遗憾在上一讲，也就是第12讲的时候，咱们对于利用AI写一个VBA宏来执行Excel任务的过程并不顺利，仔细想来既然大家都在这里看这个系列文章了，应该也基本都会Python的，所以一个Excel自动化也并无太大影响，毕竟，这种商业软件的集成一定是早晚的事情，咱们也不必在这里死磕这一个问题。"}</script><link rel="canonical" href="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="茶桁.MAMT" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="茶桁.MAMT" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/hivandu"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-28T09:17:32.000Z" title="5/28/2023, 5:17:32 PM">2023-05-28</time>发表</span><span class="level-item"><a class="link-muted" href="/categories/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%8E%A5%E8%A7%A6%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E5%A4%A7%E6%A8%A1%E5%9E%8B/">从零开始接触人工智能大模型</a></span></div></div><h1 class="title is-3 is-size-4-mobile">13 使用多步提示语让AI帮你写测试</h1><div class="content"><p>Hi，大家好，我是茶桁。</p>
<p>很遗憾在上一讲，也就是第12讲的时候，咱们对于利用AI写一个VBA宏来执行Excel任务的过程并不顺利，仔细想来既然大家都在这里看这个系列文章了，应该也基本都会Python的，所以一个Excel自动化也并无太大影响，毕竟，这种商业软件的集成一定是早晚的事情，咱们也不必在这里死磕这一个问题。</p>
<span id="more"></span>
<p>那么本节课程呢，我们会通过chatGPT的不断交互，去完成一个测试任务。</p>
<p>在很多时候，我们探索性开发一些功能可以极大提高我们的效率，但是这个过程并不能做成一个完整的产品。我们理想中的产品应该是“自动化”的，我们只需要用自然语言输入自己的需求，对应的代码就自动写出来了。</p>
<p>那么如果中间出现了问题怎么办？当然是AI可以自己拿到反馈自己更正自己了，完全不需要人工去介入调试。</p>
<p>下面，让我们开始吧。</p>
<h3 id="代码的起源">代码的起源</h3>
<p>让AI自己调试自己的需求听起来是不是很不可思议？随着GPT-4的发布，还有就是未来模型能力的进一步增强，这个骑士并不是遥不可及。是的，我又在这里贩卖焦虑了，那些低廉的测试们，想要自己的退路了吗？</p>
<p>眼下，我们只有GPT-3.5的API权限。所以我们这一次无法一步到底，目标还是需要低一点，先通过大语言模型，帮助我们写单元测试代码。</p>
<p>整个过程是一个自动档的体验，只是能够提供的能力还相对比较简单，仅限于为现有代码提供单元测试而已。</p>
<p>其实，很早的时候OpenAI官方就在Cookbook中提供了类似的思路和示例，可以参见<a target="_blank" rel="noopener" href="https://github.com/openai/openai-cookbook/blob/main/examples/Unit_test_writing_using_a_multi-step_prompt.ipynb"><strong>Unit test writing using a multi-step prompt</strong></a>，不过这个例子里面的代码已经无法使用了，因为对应的<code>code-davinci-002</code>模型已经被OpenAI下线了。但是示例里，分步骤分析问题，通过多个Prompts来完成单元测试的想法，还是完全可以拿来借鉴的。</p>
<p>虽然模型会变，代码也就需要跟着会改变，但是我相信这一课一定能打开你的思路，随着你拿到GPT-4的API乃至未来可能会出现的GPT-5，你都完全可以完成更复杂的“自动写代码”的程序。</p>
<h3 id="先从一个起点开始">先从一个起点开始</h3>
<p>为了写测试，我们需要首先编写一个程序。为了避免选择 Leetcode 这样的题库，因为这些题目可能在 AI 的训练数据集中出现并且AI已经知道了答案。因此，我选择了一个有趣的小题目，即让 Python 根据我们输入的一个整数代表的秒数，格式化成一段自然语言描述的时间。例如，输入 1 将返回 1秒，输入 61 将返回 1分钟1秒。为了实现这个功能，我们需要考虑处理输入、分析输入并将其转化为可读的输出。我们可以使用 Python 中的 datetime 模块和字符串处理功能来完成这个任务。我们可以编写单元测试来确保代码的正确性，包括测试各种输入组合的情况，并确保输出符合预期。我们还可以考虑添加错误处理，例如，如果输入不是整数，则返回错误消息。因此，编写测试代码可以帮助我们确保代码的正确性并提高代码的可读性。</p>
<p>让我们从简单需求开始：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">咱们用Python写一个函数，进行时间格式化的输出，比如:</span><br><span class="line">输入 输出</span><br><span class="line"><span class="number">1</span>          <span class="number">1</span>s</span><br><span class="line"><span class="number">61</span>        <span class="number">1</span>min1s</span><br><span class="line"></span><br><span class="line">要求仅需要格式化到小时(?h?min?s)就可以了。</span><br></pre></td></tr></table></figure>
<p>当然，我们是讲这个需求直接抛给chatGPT，让其待我们实现，然后我得到了如下程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">format_time</span>(<span class="params">seconds</span>):</span><br><span class="line">    hours = seconds // <span class="number">3600</span></span><br><span class="line">    minutes = (seconds % <span class="number">3600</span>) // <span class="number">60</span></span><br><span class="line">    seconds = seconds % <span class="number">60</span></span><br><span class="line"></span><br><span class="line">    time_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> hours &gt; <span class="number">0</span>:</span><br><span class="line">        time_string += <span class="string">f&quot;<span class="subst">&#123;hours&#125;</span>h&quot;</span></span><br><span class="line">    <span class="keyword">if</span> minutes &gt; <span class="number">0</span>:</span><br><span class="line">        time_string += <span class="string">f&quot;<span class="subst">&#123;minutes&#125;</span>min&quot;</span></span><br><span class="line">    <span class="keyword">if</span> seconds &gt; <span class="number">0</span>:</span><br><span class="line">        time_string += <span class="string">f&quot;<span class="subst">&#123;seconds&#125;</span>s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> time_string</span><br></pre></td></tr></table></figure>
<p>并且，chatGPT还十分贴心的给出了一些示例用法：</p>
<img src="/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171814.png" class="" title="img">
<p>现在让我们放在VSCode里尝试一下：</p>
<img src="/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171823.png" class="" title="img">
<p>似乎很顺利，没有报错，可以执行，而且目测代码也完成了我们想要的基本功能，使用chatGPT给的示例测试一下看看：</p>
<img src="/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171829.png" class="" title="img">
<p>恩，完全没问题。</p>
<p>好了，现在可以让我们完成单元测试的代码了，当然，依然是将问题交给chatGPT：</p>
<img src="/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171833.png" class="" title="img">
<p>然后我得到了如下回复：</p>
<img src="/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171841.png" class="" title="img">
<p>这里我们需要安装一个新库，在你的命令行内输入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install pytest</span><br></pre></td></tr></table></figure>
<p>将chatGPT给到的代码改动一下，因为毕竟我们是在一个文件内定义的类，并不存在引入的情况：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_format_time</span>():</span><br><span class="line">    <span class="comment"># 测试秒数为 1 的情况</span></span><br><span class="line">    <span class="keyword">assert</span> format_time(<span class="number">1</span>) == <span class="string">&quot;1s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试秒数为 61 的情况</span></span><br><span class="line">    <span class="keyword">assert</span> format_time(<span class="number">61</span>) == <span class="string">&quot;1min1s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试秒数为 3661 的情况</span></span><br><span class="line">    <span class="keyword">assert</span> format_time(<span class="number">3661</span>) == <span class="string">&quot;1h1min1s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试秒数为 3600 的情况</span></span><br><span class="line">    <span class="keyword">assert</span> format_time(<span class="number">3600</span>) == <span class="string">&quot;1h&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试秒数为 0 的情况</span></span><br><span class="line">    <span class="keyword">assert</span> format_time(<span class="number">0</span>) == <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试负数秒数的情况</span></span><br><span class="line">    <span class="keyword">assert</span> format_time(-<span class="number">10</span>) == <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试较大秒数的情况</span></span><br><span class="line">    <span class="keyword">assert</span> format_time(<span class="number">123456789</span>) == <span class="string">&quot;34293h21min29s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在此添加更多的测试用例...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行单元测试</span></span><br><span class="line"><span class="comment"># pytest.main()</span></span><br></pre></td></tr></table></figure>
<p>好的，我们的单元测试写完了, 下课，咱们下期再见。</p>
<p>。。。</p>
<p>当然是开玩笑的，哪有这么简单。不知道有多少人真的做过程序员或者测试，聪明如你们，当然能从这段代码中看到还存在问题</p>
<p>虽然这个测试考虑到了负数，考虑到了超过24小时较大秒数的情况，但是依然有未考虑到的情况，比如说，我们如果输入了浮点数1.0， 或者字符串abc，在活着Null这样的空值怎么办？虽然前端可以控制输入类型来避免一些情况发生，但是无论如何，我们无法相信前端，并不是因为前端程序员不给力，而是前端是可以被篡改的。我们不知道前端传回来的内容会发生怎样的变化，所以后端校验必须严谨而完整。</p>
<p>下面，让我们继续完善吧，接着我们就要离开WebGPT的交互，转而使用API了，所以请在您的代码内设置好相应的 <code>openai.api_key</code></p>
<h3 id="分步提示语">分步提示语</h3>
<p>我们要明白，就算有了AI，也并不是把问题一股脑的塞给他就可以解决了。我们需要的是反过来自己思考，如果我们自己来为一段代码写单元测试，我们自己会怎么做？</p>
<p>而这些想法，最后就会变成在chatGPT里的Prompts，最终由chatGPT告诉我们答案。</p>
<p>在文章开头我分享的Cookbook里的那个例子里就提供了一份很好的思路，在里面将问题拆成了三个步骤：</p>
<ol type="1">
<li><p>把代码提交给大语言模型，让大语言模型解释一下，这个代码是在干什么。这个步骤很重要，因为它可以帮助我们更好地理解代码的含义以及逻辑。如果大语言模型的解释不够详细，我们可以再次提交代码，直到我们完全理解了它的含义。</p></li>
<li><p>把代码以及代码的解释一起交给大语言模型，让大语言模型规划一下，针对这个代码逻辑，我们到底要写哪几个 TestCase。如果在这个过程里，大语言模型规划的 TestCase 数量太少，那么我们可以重复第二步，让 AI 多生成几个 TestCase。这样可以帮助我们更全面地测试代码，确保代码质量。</p></li>
<li><p>针对上面生成的 TestCase 的详细描述，我们再次提交给大语言模型，让它根据这些描述生成具体的测试代码。在这个过程中，我们还会对生成的代码进行一次语法检查，如果语法检查没法通过，我们就要让 AI 重新生成一下。这个可以避免因为大语言模型的概率采样不稳定，导致生成的代码无法运行的问题。同时，我们还可以对生成的代码进行一些修改，比如添加注释，让代码更加易读易懂。这个步骤可以帮助我们更好地理解代码的结构，以及代码所要实现的功能。</p></li>
</ol>
<p>到最后，我们当然需要实际运行一下这些代码，看看我们的代码是否能够通过这些自动化测试。</p>
<h3 id="自己的代码自己解释">自己的代码自己解释</h3>
<p>我们将步骤一步步拆解开来，通过Python程序把整个过程“自动化”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gpt</span>(<span class="params">prompt, model = <span class="string">&#x27;text-davinci-002&#x27;</span>, temperature = <span class="number">0.4</span>, max_tokens = <span class="number">1000</span>, top_p = <span class="number">1</span>, stop = [<span class="string">&#x27;\n\n&#x27;</span>, <span class="string">&#x27;\n\t\n&#x27;</span>, <span class="string">&#x27;\n   \n&#x27;</span>]</span>):</span><br><span class="line">    response = openai.Completion.create(</span><br><span class="line">        model = model,</span><br><span class="line">        prompt = prompt,</span><br><span class="line">        temperature = temperature,</span><br><span class="line">        max_tokens = max_tokens,</span><br><span class="line">        top_p = top_p,</span><br><span class="line">        stop = stop</span><br><span class="line">    )</span><br><span class="line">    message = response[<span class="string">&#x27;choices&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> message</span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">def format_time(seconds):</span></span><br><span class="line"><span class="string">    hours = seconds // 3600</span></span><br><span class="line"><span class="string">    minutes = (seconds % 3600) // 60</span></span><br><span class="line"><span class="string">    seconds = seconds % 60</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    time_string = &quot;&quot;</span></span><br><span class="line"><span class="string">    if hours &gt; 0:</span></span><br><span class="line"><span class="string">        time_string += f&quot;&#123;hours&#125;h&quot;</span></span><br><span class="line"><span class="string">    if minutes &gt; 0:</span></span><br><span class="line"><span class="string">        time_string += f&quot;&#123;minutes&#125;min&quot;</span></span><br><span class="line"><span class="string">    if seconds &gt; 0:</span></span><br><span class="line"><span class="string">        time_string += f&quot;&#123;seconds&#125;s&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return time_string</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">explain_code</span>(<span class="params">function_to_test, unit_test_package = <span class="string">&#x27;pytest&#x27;</span></span>):</span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;# How to write great unit tests with <span class="subst">&#123;unit_test_package&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In this advanced tutorial for experts, we&#x27;ll use Python 3.10 and `<span class="subst">&#123;unit_test_package&#125;</span>` to write a suite of unit tests to verify the behavior of the following function.</span></span><br><span class="line"><span class="string">```python</span></span><br><span class="line"><span class="string"><span class="subst">&#123;function_to_test&#125;</span></span></span><br><span class="line"><span class="string">```</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Before writing any unit tests, let&#x27;s review what each element of the function is doing exactly and what the author&#x27;s intentions may have been.</span></span><br><span class="line"><span class="string">- First,</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    response = gpt(prompt)</span><br><span class="line">    <span class="keyword">return</span> response, prompt</span><br><span class="line"></span><br><span class="line">code_explaination, prompt_to_explain_code = explain_code(code)</span><br><span class="line"><span class="built_in">print</span>(code_explaination)</span><br></pre></td></tr></table></figure>
<p>在这一步中，我们所写的代码做了以下几件事情：</p>
<p>首先，我们定义一个gpt的函数，对调用GPT3.5的模型做了一个简单的封装。其中有两点需要特别注意一下：</p>
<ol type="1">
<li><p>我们默认使用了 <code>text-davinci-002</code> 模型，这是一个通过监督学习微调的生成文本的模型。因为这里我们希望生成目标明确的文本的代码解释，所以选用了这个模型。</p></li>
<li><p>我们对 stop 做了特殊的设置，只要连续两个换行或者类似连续两个换行的情况出现，就中止数据的生成。这是避免模型一口气连测试代码也生成出来。那样的话，我们没法对测试代码的生成提出具体的要求。通过 stop，我们可以确保在第一步，只解释现在的功能代码有什么用。此外，我们还对 stop 进行了调优，确保在生成代码解释时不会因为过度使用 stop 而出现信息不完整的情况。具体来说，我们设置了一个阈值，只有当连续两个换行或类似换行的情况出现的次数达到阈值时，才会中止数据的生成。</p></li>
</ol>
<p>接下来，我们可以进一步提高代码的解释的准确性。我们可以通过以下几个步骤来实现：</p>
<ol type="1">
<li><p>确定使用pytest测试包。</p></li>
<li><p>提供要测试的代码以及相应的上下文。</p></li>
<li><p>指示AI对代码的功能进行详细描述。</p></li>
<li><p>使用“- First”等引导词，引导GPT模型逐步分行描述代码的功能。</p></li>
</ol>
<p>这些步骤可以让我们的代码解释更加清晰明了。此外，我们也可以通过提供更详细的上下文和示例来帮助GPT模型对代码的功能进行更准确的描述。例如，我们可以提供更多的测试用例，以确保代码的正确性，并帮助GPT模型更好地理解代码的功能。同时，我们还可以提供更多的注释和解释，以便其他人更好地了解我们的代码。</p>
<p>输出结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">```python</span><br><span class="line">  seconds // <span class="number">3600</span></span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> dividing the number of seconds by <span class="number">3600</span> <span class="keyword">and</span> discarding the remainder. For example, `<span class="number">7200</span> // <span class="number">3600</span>` returns `<span class="number">2</span>` because there are `<span class="number">2</span>` hours <span class="keyword">in</span> `<span class="number">7200</span>` seconds.</span><br><span class="line">- Second,</span><br><span class="line">  ```python</span><br><span class="line">  (seconds % <span class="number">3600</span>) // <span class="number">60</span></span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> dividing the remainder of the division of `seconds` by `<span class="number">3600</span>` by `<span class="number">60</span>`. For example, `<span class="number">7200</span> % <span class="number">3600</span>` returns `<span class="number">0</span>` because there are no seconds remaining after the division by `<span class="number">3600</span>`. Therefore, `(<span class="number">7200</span> % <span class="number">3600</span>) // <span class="number">60</span>` returns `<span class="number">0</span>` because there are no minutes remaining after the division by `<span class="number">60</span>`.</span><br><span class="line">- Third,</span><br><span class="line">  ```python</span><br><span class="line">  seconds % <span class="number">60</span></span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> returning the remainder of the division of `seconds` by `<span class="number">60</span>`. For example, `<span class="number">7200</span> % <span class="number">60</span>` returns `<span class="number">0</span>` because there are no seconds remaining after the division by `<span class="number">60</span>`.</span><br><span class="line">- Fourth,</span><br><span class="line">  ```python</span><br><span class="line">  time_string = <span class="string">&quot;&quot;</span></span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> initializing an empty string to be used to store the formatted time.</span><br><span class="line">- Fifth,</span><br><span class="line">  ```python</span><br><span class="line">  <span class="keyword">if</span> hours &gt; <span class="number">0</span>:</span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> checking <span class="keyword">if</span> the number of `hours` <span class="keyword">is</span> greater than `<span class="number">0</span>`. If it <span class="keyword">is</span>, the following code will be executed.</span><br><span class="line">  ```python</span><br><span class="line">  time_string += <span class="string">f&quot;<span class="subst">&#123;hours&#125;</span>h&quot;</span></span><br><span class="line">  ```</span><br><span class="line">  This code <span class="keyword">is</span> adding the number of `hours` to the string `time_string` <span class="keyword">with</span> the `h` character after it. For example, <span class="keyword">if</span> `hours` <span class="keyword">is</span> `<span class="number">2</span>`, the string `time_string` will be updated to `<span class="string">&quot;2h&quot;</span>`.</span><br><span class="line">- Sixth,</span><br><span class="line">  ```python</span><br><span class="line">  <span class="keyword">if</span> minutes &gt; <span class="number">0</span>:</span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> checking <span class="keyword">if</span> the number of `minutes` <span class="keyword">is</span> greater than `<span class="number">0</span>`. If it <span class="keyword">is</span>, the following code will be executed.</span><br><span class="line">  ```python</span><br><span class="line">  time_string += <span class="string">f&quot;<span class="subst">&#123;minutes&#125;</span>min&quot;</span></span><br><span class="line">  ```</span><br><span class="line">  This code <span class="keyword">is</span> adding the number of `minutes` to the string `time_string` <span class="keyword">with</span> the `<span class="built_in">min</span>` characters after it. For example, <span class="keyword">if</span> `minutes` <span class="keyword">is</span> `<span class="number">2</span>`, the string `time_string` will be updated to `<span class="string">&quot;2min&quot;</span>`.</span><br><span class="line">- Seventh,</span><br><span class="line">  ```python</span><br><span class="line">  <span class="keyword">if</span> seconds &gt; <span class="number">0</span>:</span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> checking <span class="keyword">if</span> the number of `seconds` <span class="keyword">is</span> greater than `<span class="number">0</span>`. If it <span class="keyword">is</span>, the following code will be executed.</span><br><span class="line">  ```python</span><br><span class="line">  time_string += <span class="string">f&quot;<span class="subst">&#123;seconds&#125;</span>s&quot;</span></span><br><span class="line">  ```</span><br><span class="line">  This code <span class="keyword">is</span> adding the number of `seconds` to the string `time_string` <span class="keyword">with</span> the `s` character after it. For example, <span class="keyword">if</span> `seconds` <span class="keyword">is</span> `<span class="number">2</span>`, the string `time_string` will be updated to `<span class="string">&quot;2s&quot;</span>`.</span><br><span class="line">- Eighth,</span><br><span class="line">  ```python</span><br><span class="line">  <span class="keyword">return</span> time_string</span><br><span class="line">  ```</span><br><span class="line">  <span class="keyword">is</span> returning the string `time_string`.</span><br></pre></td></tr></table></figure>
<p>运行代码后，AI回复了我们几个步骤，详细秒数了我们格式化时间的代码是如何做的。</p>
<h3 id="自己的解释自己实现">自己的解释自己实现</h3>
<p>当然接下来，我们就需要根据生成的这个详细描述，请AI为我们制定一下具体的测试计划了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_a_test_plan</span>(<span class="params">full_code_explaination, unit_test_package=<span class="string">&quot;pytest&quot;</span></span>):</span><br><span class="line">    prompt_to_explain_a_plan = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">A good unit test suite should aim to:</span></span><br><span class="line"><span class="string">- Test the function&#x27;s behavior for a wide range of possible inputs</span></span><br><span class="line"><span class="string">- Test edge cases that the author may not have foreseen</span></span><br><span class="line"><span class="string">- Take advantage of the features of `<span class="subst">&#123;unit_test_package&#125;</span>` to make the tests easy to write and maintain</span></span><br><span class="line"><span class="string">- Be easy to read and understand, with clean code and descriptive names</span></span><br><span class="line"><span class="string">- Be deterministic, so that the tests always pass or fail in the same way</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`<span class="subst">&#123;unit_test_package&#125;</span>` has many convenient features that make it easy to write and maintain unit tests. We&#x27;ll use them to write unit tests for the function above.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For this particular function, we&#x27;ll want our unit tests to handle the following diverse scenarios (and under each scenario, we include a few examples as sub-bullets):</span></span><br><span class="line"><span class="string">-&quot;&quot;&quot;</span></span><br><span class="line">    prompt = full_code_explaination + prompt_to_explain_a_plan</span><br><span class="line">    response = gpt(prompt)</span><br><span class="line">    <span class="keyword">return</span> response, prompt</span><br><span class="line"></span><br><span class="line">test_plan, prompt_to_get_test_plan = generate_a_test_plan(prompt_to_explain_code + code_explaination)</span><br><span class="line"><span class="built_in">print</span>(test_plan)</span><br></pre></td></tr></table></figure>
<p>我们整个测试计划的提示语，同样经过了精心设计。我们首先对 AI 的测试用例做出了以下要求：</p>
<ol type="1">
<li><p>在考虑输入范围时，测试用例应尽可能覆盖更广的范围。</p></li>
<li><p>AI 应考虑到一些边界条件，这些条件可能比代码作者预想的更加复杂。</p></li>
<li><p>我们希望 AI 能够充分利用 pytest 这个测试包的特性。</p></li>
<li><p>测试用例应该易于阅读和理解，测试代码应该简洁明了。</p></li>
<li><p>测试代码的输出结果应该是确定的，要么通过，要么失败，不应该有随机性。</p></li>
</ol>
<p>在这一步之后，我们并没有让 AI 立即开始编写测试代码。相反，我们提供了几个例子来让 AI 生成一系列示例。我们对测试用例的提示非常详细，这也是我们之前没有让 AI 直接生成测试用例的原因。因为这种方法无法在提示语中插入这些详细的要求。对于具体的测试用例，我们只能希望 AI 能够自行想出更多的例子。</p>
<p>最后，我们的提示语既包括了第一步要求解释代码内容的要求，也包括了 AI 生成的代码解释的要求，以及我们在这里新增的测试用例要求。这提供了非常详细的上下文，使得 AI 的表现更好，更具有逻辑性。此外，我们建议 AI 参考其他相关测试用例，以确保测试的全面性和正确性。</p>
<p>然后AI输出了结果给我：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">The `seconds` <span class="built_in">input</span> <span class="keyword">is</span> a positive integer:</span><br><span class="line">  - `seconds` <span class="keyword">is</span> less than <span class="number">60</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> equal to <span class="number">60</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> greater than <span class="number">60</span> but less than <span class="number">3600</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> equal to <span class="number">3600</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> greater than <span class="number">3600</span></span><br><span class="line">- The `seconds` <span class="built_in">input</span> <span class="keyword">is</span> a negative integer:</span><br><span class="line">  - `seconds` <span class="keyword">is</span> less than -<span class="number">60</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> equal to -<span class="number">60</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> greater than -<span class="number">60</span> but less than -<span class="number">3600</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> equal to -<span class="number">3600</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> greater than -<span class="number">3600</span></span><br><span class="line">- The `seconds` <span class="built_in">input</span> <span class="keyword">is</span> a <span class="built_in">float</span>:</span><br><span class="line">  - `seconds` <span class="keyword">is</span> less than <span class="number">0.0</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> equal to <span class="number">0.0</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> greater than <span class="number">0.0</span> but less than <span class="number">60.0</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> equal to <span class="number">60.0</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> greater than <span class="number">60.0</span> but less than <span class="number">3600.0</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> equal to <span class="number">3600.0</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> greater than <span class="number">3600.0</span></span><br><span class="line">- The `seconds` <span class="built_in">input</span> <span class="keyword">is</span> a string:</span><br><span class="line">  - `seconds` <span class="keyword">is</span> an empty string</span><br><span class="line">  - `seconds` <span class="keyword">is</span> a string that can be parsed to an integer</span><br><span class="line">  - `seconds` <span class="keyword">is</span> a string that can be parsed to a <span class="built_in">float</span></span><br><span class="line">  - `seconds` <span class="keyword">is</span> a string that cannot be parsed to an integer <span class="keyword">or</span> a <span class="built_in">float</span></span><br><span class="line">- The `seconds` <span class="built_in">input</span> <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">  - `seconds` <span class="keyword">is</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>我运行了一下这个代码，可以看到，AI 提供了很多测试用例。并且，里面考虑了好几种情况，包括我们前面提到的负数这样的特殊条件，也包括输入字符串，以及 None 这样的内容。不仅如此，我们还可以探索更多的情况，例如小数和分数等。此外，我们可以调整代码中的参数，来观察AI生成的测试用例数量和质量。</p>
<p>不过，生成哪些用例其实是有一定的随机性的。这个也是大语言模型的一个缺点，就是可控性差。有时候，AI 可能就只生成了 3 个用例，那样的话就会有很多情况我们的用例覆盖不到。</p>
<p>所以，我们可以在生成用例之后，加一个步骤，检查一下到底生成了多少个用例。如果太少的话，我们就让 AI 再生成一些。我在下面给了一段示例代码，通过“-”这样一个换行加横杆的标记来判断之前生成的测试用例数量，如果比我们设定的下限少，我们就再添加一段提示语，让 AI 再生成一些。</p>
<p>这里的提示语，我们要特别提醒 AI 考虑一下测试罕见情况和边界条件，例如极大或极小的输入值，或者一些异常情况的处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">not_enough_test_plan = <span class="string">&quot;&quot;&quot;The function is called with a valid number of seconds</span></span><br><span class="line"><span class="string">    - `format_time(1)` should return `&quot;1s&quot;`</span></span><br><span class="line"><span class="string">    - `format_time(59)` should return `&quot;59s&quot;`</span></span><br><span class="line"><span class="string">    - `format_time(60)` should return `&quot;1min&quot;`</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">approx_min_cases_to_cover = <span class="number">7</span></span><br><span class="line">elaboration_needed = test_plan.count(<span class="string">&quot;\n-&quot;</span>) +<span class="number">1</span> &lt; approx_min_cases_to_cover </span><br><span class="line"><span class="keyword">if</span> elaboration_needed:</span><br><span class="line">        prompt_to_elaborate_on_the_plan = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In addition to the scenarios above, we&#x27;ll also want to make sure we don&#x27;t forget to test rare or unexpected edge cases (and under each edge case, we include a few examples as sub-bullets):</span></span><br><span class="line"><span class="string">-&quot;&quot;&quot;</span></span><br><span class="line">        more_test_plan, prompt_to_get_test_plan = generate_a_test_plan(prompt_to_explain_code + code_explaination + not_enough_test_plan + prompt_to_elaborate_on_the_plan)</span><br><span class="line">        <span class="built_in">print</span>(more_test_plan)</span><br></pre></td></tr></table></figure>
<p>然后得到结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">The function <span class="keyword">is</span> called <span class="keyword">with</span> a valid number of seconds</span><br><span class="line">    - `format_time(<span class="number">1</span>)` should <span class="keyword">return</span> `<span class="string">&quot;1s&quot;</span>`</span><br><span class="line">    - `format_time(<span class="number">59</span>)` should <span class="keyword">return</span> `<span class="string">&quot;59s&quot;</span>`</span><br><span class="line">    - `format_time(<span class="number">60</span>)` should <span class="keyword">return</span> `<span class="string">&quot;1min&quot;</span>`</span><br><span class="line">- The function <span class="keyword">is</span> called <span class="keyword">with</span> an invalid number of seconds</span><br><span class="line">    - `format_time(-<span class="number">1</span>)` should <span class="keyword">raise</span> a `ValueError`</span><br><span class="line">    - `format_time(<span class="string">&quot;60&quot;</span>)` should <span class="keyword">raise</span> a `ValueError`</span><br><span class="line">- The function <span class="keyword">is</span> called <span class="keyword">with</span> a valid number of seconds <span class="keyword">and</span> the `hours`, `minutes`, <span class="keyword">or</span> `seconds` are `<span class="number">0</span>`</span><br><span class="line">    - `format_time(<span class="number">0</span>)` should <span class="keyword">return</span> `<span class="string">&quot;&quot;</span>`</span><br><span class="line">    - `format_time(<span class="number">3600</span>)` should <span class="keyword">return</span> `<span class="string">&quot;1h&quot;</span>`</span><br><span class="line">    - `format_time(<span class="number">7200</span>)` should <span class="keyword">return</span> `<span class="string">&quot;2h&quot;</span>`</span><br><span class="line">    - `format_time(<span class="number">7201</span>)` should <span class="keyword">return</span> `<span class="string">&quot;2h1s&quot;</span>`</span><br></pre></td></tr></table></figure>
<h3 id="自己的计划自己生成">自己的计划自己生成</h3>
<p>当然，有些情况下，生成的测试用例数会比我们的实际情况更少。这时候，我们需要想办法增加测试用例的数量，以便更全面地测试我们的代码。一种方法是增加测试数据的覆盖范围。我们可以通过添加一些边界值、特殊值、无效值等来增加测试用例的数量。</p>
<p>除了增加测试用例的数量，我们还可以增加测试用例的复杂度。这样可以更好地测试代码的鲁棒性和可扩展性。我们可以通过增加测试用例的步骤、条件等来增加测试用例的复杂度。</p>
<p>另外，为了提高测试用例的可读性和可维护性，我们可以将测试用例分为不同的类别，并为每个类别定义一个清晰的目标。例如，我们可以将测试用例按照输入数据的类型、函数的不同参数组合、不同的执行路径等进行分类。</p>
<p>对于这些分类，我们可以在提示语中指明要测试的具体内容，以帮助 AI 编写更加精确、全面的测试用例。同时，我们还可以提供一些代码示例或者代码注释来帮助 AI 理解我们要测试的功能代码。</p>
<p>需要注意的是，我们在生成提示语的时候，要尽可能保留原有的关键信息，以确保 AI 编写的测试用例符合我们的测试要求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_test_cases</span>(<span class="params">function_to_test, unit_test_package=<span class="string">&quot;pytest&quot;</span></span>):</span><br><span class="line">    starter_comment = <span class="string">&quot;Below, each test case is represented by a tuple passed to the @pytest.mark.parametrize decorator&quot;</span></span><br><span class="line">    prompt_to_generate_the_unit_test = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Before going into the individual tests, let&#x27;s first look at the complete suite of unit tests as a cohesive whole. We&#x27;ve added helpful comments to explain what each line does.</span></span><br><span class="line"><span class="string">```python</span></span><br><span class="line"><span class="string">import <span class="subst">&#123;unit_test_package&#125;</span>  # used for our unit tests</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;function_to_test&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#<span class="subst">&#123;starter_comment&#125;</span>&quot;&quot;&quot;</span></span><br><span class="line">    full_unit_test_prompt = prompt_to_explain_code + code_explaination + test_plan + prompt_to_generate_the_unit_test</span><br><span class="line">    <span class="keyword">return</span> gpt(model=<span class="string">&quot;text-davinci-003&quot;</span>, prompt=full_unit_test_prompt, stop=<span class="string">&quot;```&quot;</span>), prompt_to_generate_the_unit_test</span><br><span class="line"></span><br><span class="line">unit_test_response, prompt_to_generate_the_unit_test = generate_test_cases(code)</span><br><span class="line"><span class="built_in">print</span>(unit_test_response)</span><br></pre></td></tr></table></figure>
<p>再次，AI为我生成了如下内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#The first element of the tuple is a string that describes the test case,</span></span><br><span class="line"><span class="comment">#and the second element is the input for the format_time function.</span></span><br><span class="line"><span class="meta">@pytest.mark.parametrize(<span class="params"><span class="string">&quot;test_case, seconds&quot;</span>, [</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># Positive integer tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Less than 60&quot;</span>, <span class="number">59</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 60&quot;</span>, <span class="number">60</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 60 but less than 3600&quot;</span>, <span class="number">7200</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 3600&quot;</span>, <span class="number">3600</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 3600&quot;</span>, <span class="number">7201</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># Negative integer tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Less than -60&quot;</span>, -<span class="number">59</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to -60&quot;</span>, -<span class="number">60</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than -60 but less than -3600&quot;</span>, -<span class="number">7200</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to -3600&quot;</span>, -<span class="number">3600</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than -3600&quot;</span>, -<span class="number">7201</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># Float tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Less than 0.0&quot;</span>, -<span class="number">1.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 0.0&quot;</span>, <span class="number">0.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 0.0 but less than 60.0&quot;</span>, <span class="number">59.9</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 60.0&quot;</span>, <span class="number">60.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 60.0 but less than 3600.0&quot;</span>, <span class="number">7200.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 3600.0&quot;</span>, <span class="number">3600.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 3600.0&quot;</span>, <span class="number">7201.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># String tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Empty string&quot;</span>, <span class="string">&quot;&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;String that can be parsed to an integer&quot;</span>, <span class="string">&quot;7200&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;String that can be parsed to a float&quot;</span>, <span class="string">&quot;7200.0&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;String that cannot be parsed to an integer or a float&quot;</span>, <span class="string">&quot;7200.0.0&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># None test</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;None&quot;</span>, <span class="literal">None</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_format_time</span>(<span class="params">test_case, seconds</span>):</span><br><span class="line">    <span class="comment"># This test checks that the output of the format_time function</span></span><br><span class="line">    <span class="comment"># is the expected output for the given input.</span></span><br><span class="line">    expected_output = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> seconds <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        hours = seconds // <span class="number">3600</span></span><br><span class="line">        minutes = (seconds % <span class="number">3600</span>) // <span class="number">60</span></span><br><span class="line">        seconds = seconds % <span class="number">60</span></span><br><span class="line">        <span class="keyword">if</span> hours &gt; <span class="number">0</span>:</span><br><span class="line">            expected_output += <span class="string">f&quot;<span class="subst">&#123;hours&#125;</span>h&quot;</span></span><br><span class="line">        <span class="keyword">if</span> minutes &gt; <span class="number">0</span>:</span><br><span class="line">            expected_output += <span class="string">f&quot;<span class="subst">&#123;minutes&#125;</span>min&quot;</span></span><br><span class="line">        <span class="keyword">if</span> seconds &gt; <span class="number">0</span>:</span><br><span class="line">            expected_output += <span class="string">f&quot;<span class="subst">&#123;seconds&#125;</span>s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> format_time(seconds) == expected_output</span><br></pre></td></tr></table></figure>
<p>在运行这段提示语之后，我们可以得到最终输出的测试代码。除了正常情况下的测试，还包括异常输入的测试。如果输入错误，代码也会输出警告信息。这样，我们可以确保代码在各种情况下都能够正常工作。同时，我们也可以添加更多的测试用例，以覆盖更多的情况，从而提高代码的质量和可靠性。因此，如果您需要进行测试，可以使用这个测试代码作为起点，随时添加新的测试用例。这将有助于确保您的代码在各种情况下都能够正常运行。</p>
<p>最后还缺少了什么？当然是语法检查。</p>
<h3 id="通过-ast-库进行语法检查">通过 AST 库进行语法检查</h3>
<p>我们建议使用Python的AST库再次检查生成的测试代码的语法。这样我们可以确保我们的测试代码是具有正确语法的。需要注意的是，在检查语法时，我们不仅需要生成的测试代码，还需要原始的功能代码。这样才能通过语法检查。另外，为了更好地测试代码，您可以考虑添加一些额外的测试用例，以确保代码的正确性和稳定性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line">code_start_index = prompt_to_generate_the_unit_test.find(<span class="string">&quot;```python\n&quot;</span>) + <span class="built_in">len</span>(<span class="string">&quot;```python\n&quot;</span>)</span><br><span class="line">code_output = prompt_to_generate_the_unit_test[code_start_index:] + unit_test_response</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    ast.parse(code_output)</span><br><span class="line"><span class="keyword">except</span> SyntaxError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Syntax error in generated code: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>非常幸运，直接通过了语法检查。下一步，我们把对应的整个测试代码打印出来执行试试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(code_output)</span><br></pre></td></tr></table></figure>
<p>输出结果最后AI帮我们生成的测试代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest  <span class="comment"># used for our unit tests</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_time</span>(<span class="params">seconds</span>):</span><br><span class="line">    hours = seconds // <span class="number">3600</span></span><br><span class="line">    minutes = (seconds % <span class="number">3600</span>) // <span class="number">60</span></span><br><span class="line">    seconds = seconds % <span class="number">60</span></span><br><span class="line"></span><br><span class="line">    time_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> hours &gt; <span class="number">0</span>:</span><br><span class="line">        time_string += <span class="string">f&quot;<span class="subst">&#123;hours&#125;</span>h&quot;</span></span><br><span class="line">    <span class="keyword">if</span> minutes &gt; <span class="number">0</span>:</span><br><span class="line">        time_string += <span class="string">f&quot;<span class="subst">&#123;minutes&#125;</span>min&quot;</span></span><br><span class="line">    <span class="keyword">if</span> seconds &gt; <span class="number">0</span>:</span><br><span class="line">        time_string += <span class="string">f&quot;<span class="subst">&#123;seconds&#125;</span>s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> time_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Below, each test case is represented by a tuple passed to the @pytest.mark.parametrize decorator.</span></span><br><span class="line"><span class="comment">#The first element of the tuple is a string that describes the test case,</span></span><br><span class="line"><span class="comment">#and the second element is the input for the format_time function.</span></span><br><span class="line"><span class="meta">@pytest.mark.parametrize(<span class="params"><span class="string">&quot;test_case, seconds&quot;</span>, [</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># Positive integer tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Less than 60&quot;</span>, <span class="number">59</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 60&quot;</span>, <span class="number">60</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 60 but less than 3600&quot;</span>, <span class="number">7200</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 3600&quot;</span>, <span class="number">3600</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 3600&quot;</span>, <span class="number">7201</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># Negative integer tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Less than -60&quot;</span>, -<span class="number">59</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to -60&quot;</span>, -<span class="number">60</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than -60 but less than -3600&quot;</span>, -<span class="number">7200</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to -3600&quot;</span>, -<span class="number">3600</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than -3600&quot;</span>, -<span class="number">7201</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># Float tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Less than 0.0&quot;</span>, -<span class="number">1.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 0.0&quot;</span>, <span class="number">0.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 0.0 but less than 60.0&quot;</span>, <span class="number">59.9</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 60.0&quot;</span>, <span class="number">60.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 60.0 but less than 3600.0&quot;</span>, <span class="number">7200.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Equal to 3600.0&quot;</span>, <span class="number">3600.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Greater than 3600.0&quot;</span>, <span class="number">7201.0</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># String tests</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;Empty string&quot;</span>, <span class="string">&quot;&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;String that can be parsed to an integer&quot;</span>, <span class="string">&quot;7200&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;String that can be parsed to a float&quot;</span>, <span class="string">&quot;7200.0&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;String that cannot be parsed to an integer or a float&quot;</span>, <span class="string">&quot;7200.0.0&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="comment"># None test</span></span></span></span><br><span class="line"><span class="params"><span class="meta">    (<span class="params"><span class="string">&quot;None&quot;</span>, <span class="literal">None</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_format_time</span>(<span class="params">test_case, seconds</span>):</span><br><span class="line">    <span class="comment"># This test checks that the output of the format_time function</span></span><br><span class="line">    <span class="comment"># is the expected output for the given input.</span></span><br><span class="line">    expected_output = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> seconds <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        hours = seconds // <span class="number">3600</span></span><br><span class="line">        minutes = (seconds % <span class="number">3600</span>) // <span class="number">60</span></span><br><span class="line">        seconds = seconds % <span class="number">60</span></span><br><span class="line">        <span class="keyword">if</span> hours &gt; <span class="number">0</span>:</span><br><span class="line">            expected_output += <span class="string">f&quot;<span class="subst">&#123;hours&#125;</span>h&quot;</span></span><br><span class="line">        <span class="keyword">if</span> minutes &gt; <span class="number">0</span>:</span><br><span class="line">            expected_output += <span class="string">f&quot;<span class="subst">&#123;minutes&#125;</span>min&quot;</span></span><br><span class="line">        <span class="keyword">if</span> seconds &gt; <span class="number">0</span>:</span><br><span class="line">            expected_output += <span class="string">f&quot;<span class="subst">&#123;seconds&#125;</span>s&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> format_time(seconds) == expected_output</span><br></pre></td></tr></table></figure>
<h3 id="抓个bug试试">抓个BUG试试</h3>
<p>我们可以试着在 Notebook 里面调用一下 format_time(-1)，看看自动化测试跑得对不对。</p>
<img src="/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/20230601171855.png" class="" title="img">
<p>如图可以看到，输入-1的时候，输出变成了59min59s, 确实AI生成的测试代码帮我们捕捉到了一个Bug。</p>
<h3 id="小结">小结</h3>
<p>好了，到这里这一讲也就结束了。我们不仅学会了如何利用一个方法，将一个问题拆分成多个提示语的步骤，循序渐进地让 AI 通过解释代码，构造测试用例，最后再根据代码的解释和设计的测试用例，生成最终的自动化测试，而且还学会了如何在这个过程中，增加更多的内容，以达到更全面的测试。</p>
<p>在生成整套测试代码的过程中，我们不需要人工地复制粘帖任何内容，全都是代码自动完成的，是一个“自动档”的过程。通过将一个问题拆分成多个提示语的步骤，我们的内容变得更加有条理、有逻辑，也更符合我们平时写文字的方式，而不是一股脑地把各种要求都放在提示语的开头，这在解决复杂问题时往往效果不好。</p>
<p>此外，我们还学会了使用多步提示语的好处。多步提示语带来的一个好处，就是能让 AI 考虑各种边界条件。在得到代码的解释之后，我们可以让 AI 考虑 -1、None 这样的特殊输入，从而涵盖更多的测试情况。这样，我们的测试代码最终真的抓住了程序里的 Bug。</p>
<p>回过头来看，如果我们只是直接把代码往 ChatGPT 里一贴，虽然也能生成测试用例，但是那些测试用例就比较欠考虑，不会涵盖各种边角的情况。因此，我们在生成测试用例的过程中，应该尽可能地提供更多的提示语，让 AI 的测试代码更加全面和详尽。</p>
<h3 id="思考题">思考题</h3>
<p>在本讲中，代码内容有点长，思考题部分需要你思考的内容更多。</p>
<ol type="1">
<li><p>你可以试着减少我们的提示语或者提示步骤，看看生成的测试用例有什么样的变化。你可以尝试移除一些提示语，或者更换提示步骤的顺序，从而得到不同的测试结果。</p></li>
<li><p>目前我们的代码是以过程式方式一步步演示整个测试代码是如何生成的。如果语法检查出错了，我们实际上应该从头开始重试一遍，再次生成测试代码。你可以尝试将整个代码封装修改，变成一个会自动重试 3 次的函数。这样，我们就可以直接调用这个函数，为 Python 代码生成自动化测试了。</p></li>
<li><p>我们本讲中的提示语是借鉴了 OpenAI Cookbook 的样例。你可以尝试总结一下，这些提示语中有哪些常用的方法是值得借鉴的。</p></li>
</ol>
<p>欢迎你将你的思考结果分享在评论区，同时也欢迎你将本讲分享给感兴趣的朋友。我们下一讲再见。</p>
<h3 id="推荐阅读">推荐阅读</h3>
<p>我们之所以要循序渐进地提示 AI，让 AI 先生成例子再生成代码，是因为现在的大型语言模型具有一种名为“思维链（CoT）”的能力。当我们提供更详细的推理步骤时，AI 的表现会更好。在 OpenAI Cookbook 中，有一章专门介绍了<a target="_blank" rel="noopener" href="https://github.com/openai/openai-cookbook/blob/main/techniques_to_improve_reliability.md">思维链的能力</a>，你可以去仔细研读一下。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>13 使用多步提示语让AI帮你写测试</p><p><a href="https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/">https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Hivan Du</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2023-05-28</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-06-01</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AI/">AI</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=6479444288ae9600196fa98e&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="https://afdian.net/item/72907364008511ee904852540025c377" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://qiniu.hivan.me/picGo/20230601221633.jpeg" alt="支付宝"></span></a><a class="button donate" href="https://www.buymeacoffee.com/hivandu" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button donate" href="https://patreon.com/user?u=89473430" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><a class="button donate" data-type="paypal" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="doo@hivan.me"><input type="hidden" name="currency_code" value="USD"></form><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://qiniu.hivan.me/IMG_4603.JPG" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/Use-AI-to-write-a-snake-game/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">利用AI写一个『贪吃蛇游戏』</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/AI-create-a-excel-plugin/"><span class="level-item">12 AI帮你写个小插件，轻松处理Excel文件</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://hivan.me/Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/';
            this.page.identifier = 'Use-multi-step-prompts-to-ask-AI-to-write-tests-for-you/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'hivan' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://www.gravatar.com/avatar/bdff168cf8a71c11d2712a1679a00c54?s=128" alt="茶桁"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">茶桁</p><p class="is-size-6 is-block">AI游民</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shang Hai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">152</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">15</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/hivandu" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/hivandu"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/hivan"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/hivan"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com/hivan"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NzE4MDQzMg==&amp;action=getalbum&amp;album_id=2932504849574543360&amp;scene=173&amp;from_msgid=2648747980&amp;from_itemidx=1&amp;count=3&amp;nolastread=1&amp;token=1758883909&amp;lang=zh_CN#wechat_redirect"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.zhihu.com/column/c_1424326166602178560" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">塌缩的奇点</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhihu.com/column/hivandu" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">茶桁-知乎</span></span><span class="level-right"><span class="level-item tag">www.zhihu.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%8E%A5%E8%A7%A6%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E5%A4%A7%E6%A8%A1%E5%9E%8B/"><span class="level-start"><span class="level-item">从零开始接触人工智能大模型</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-26T08:31:43.000Z">2023-07-26</time></p><p class="title"><a href="/%E5%B0%9D%E8%AF%95%E8%AE%A9%E6%9C%BA%E5%99%A8%E6%8B%A5%E6%9C%89%E5%A3%B0%E9%9F%B3/">20. 尝试让机器拥有声音</a></p><p class="categories"><a href="/categories/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%8E%A5%E8%A7%A6%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E5%A4%A7%E6%A8%A1%E5%9E%8B/">从零开始接触人工智能大模型</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-21T04:47:54.000Z">2023-07-21</time></p><p class="title"><a href="/BardAPI-ChatGPT/">将 Bard API 与 ChatGPT 集成：实时数据访问</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-15T07:18:39.000Z">2023-07-15</time></p><p class="title"><a href="/%E4%BD%BF%E7%94%A8Transformers%E8%BF%9B%E8%A1%8C%E8%AF%AD%E9%9F%B3%E8%BD%AC%E6%96%87%E6%9C%AC/">使用 Transformers 进行语音转文本的完整入门指南</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-14T06:30:00.000Z">2023-07-14</time></p><p class="title"><a href="/LLMs%E7%9A%84%E5%AE%9E%E7%94%A8%E4%BB%8B%E7%BB%8D/">LLMs的实用介绍</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-10T14:52:54.000Z">2023-07-10</time></p><p class="title"><a href="/%E5%BF%AB%E9%80%9F%E5%80%BE%E5%90%AC%E5%92%8C%E6%80%BB%E7%BB%93%E9%9F%B3%E9%A2%91%E5%86%85%E5%AE%B9/">19. 快速倾听和总结音频内容</a></p><p class="categories"><a href="/categories/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%8E%A5%E8%A7%A6%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E5%A4%A7%E6%A8%A1%E5%9E%8B/">从零开始接触人工智能大模型</a></p></div></article></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="茶桁.MAMT" height="28"></a><p class="is-size-7"><span>&copy; 2023 Hivan Du</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/hivandu"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>